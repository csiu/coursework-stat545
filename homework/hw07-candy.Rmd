---
title: 'hw07: Bring the Candy Survey data'
author: "csiu"
date: "November 8, 2015"
output: html_document
---
```{r}
knitr::opts_chunk$set(fig.path='figure/hw07-')
options(knitr.table.format = 'markdown')
```

I have clean up candy data here: 

- add [user id column](https://github.com/csiu/candyplay/blob/master/data-raw/02_add-user-column.md)
- cleanup for [general factors](https://github.com/csiu/candyplay/blob/master/data-raw/03_tidy1.md) | resulting [csv file](https://github.com/csiu/candyplay/blob/master/data-raw/03_tidy1.csv)
- cleanup for [guess number of mints](https://github.com/csiu/candyplay/blob/master/data-raw/04_tidy2-mints.md) | resulting [csv file](https://github.com/csiu/candyplay/blob/master/data-raw/04_tidy2-mints.csv)
- cleanup for [age](https://github.com/csiu/candyplay/blob/master/data-raw/05_tidy3-age.md) | resulting [csv file](https://github.com/csiu/candyplay/blob/master/data-raw/05_tidy3-age.csv)
- cleanup for [the candy itself](https://github.com/csiu/candyplay/blob/master/data-raw/06_tidy4-candy.md) | resulting [csv file](https://github.com/csiu/candyplay/blob/master/data-raw/06_tidy4-candy.csv)

# Use of candy data

I want to explore mints. 

----
## The questions:
1. If you guess there is more mints in my hand, do you feel more joy towards mint candy?
2. If you're taking the survey late at night, do you guess there is more mints in my hand?
3. Do people 40 or older feel more joy towards mint candy?
4. Given the people who said they were old, are we able to predict their age given preference towards mint candy & the number of mints they guess?

## Data cleaning:
Load packages:
```{r}
library(readr)
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(dplyr))
library(ggplot2)
```

Load raw data:

```{r}
raw <- read_csv("../data/candy-survey-2015.csv")
```

Here are the columns of the raw data:
```{r}
colnames(raw)
```

Find columns of interest for analyzing mint data e.g. time of response, age of surveyee, any candy with the word "mint" in it, and the guess of the number of mints in my hands.
```{r}
(columns_of_interest <- colnames(raw) %>% 
   grep("Timestamp|How old are you?|mint", ., value = TRUE, ignore.case = TRUE))
```

**Cleanup `timestamp`** by re-reading the file & creating a new `user` id column
```{r}
raw <- read_csv("../data/candy-survey-2015.csv",
                col_types = cols(
                  Timestamp = col_datetime("%m/%d/%Y %H:%M:%S")
                ))
raw <- raw %>% 
  mutate(user = sprintf("ID-%04d", order(Timestamp)))
```

Select and rename the columns of interest e.g. 

- replacing "How old are you?" with "age"
- replacing "Guess the number of mints in my hand." with "n_mints"
- removing `[` and `]` 

```{r}
raw <- raw[,c("user", columns_of_interest)]

colnames(raw) <- plyr::revalue(colnames(raw), 
                               replace = c("How old are you?" = "age", 
                                           "Guess the number of mints in my hand." = "n_mints",
                                           "Timestamp" = "timestamp"))
colnames(raw) <- gsub("^\\[|\\]$", "", colnames(raw))
colnames(raw)
```

**Cleanup `age`**, but first need to see what needs to be done:

```{r}
raw %>% 
  filter(!grepl("^\\d+$", age), !is.na(age)) %>% 
  mutate(age = tolower(age)) %>% 
  group_by(age) %>% 
  summarise(count = length(age)) %>% 
  knitr::kable(format="markdown")
```

To do:

- fix "37 (i’m taking a child)" and "42 - i’m taking my kid" by `grep`-ing for **taking** (Note those are the only instances of "taking") and keeping only the first 2 character in string
- remove `,` and `:` from "37," and "46:"
- replace "good lord! I’m 43!" with "43"
- replace "40. deal with it.", "45, but the 8-year-old huntress and bediapered unicorn give me political cover and social respectability. however, i will eat more than they do combined.", and "50 (despair)" with only the first 2 characters in string
- convert values to integers (and replace those that fail conversion with NA)
- and keep only ages in valid ranges e.g. between 1 (i.e. don't want babies) - 116 (i.e. surveyee should be younger than the [oldest living person, Susannah Mushatt Jones, age 116](https://en.wikipedia.org/wiki/List_of_the_verified_oldest_people)).

```{r}
## Save those that self report as old -- to be used later
self_reported_as_old <- raw %>% 
  mutate(age = tolower(age)) %>% 
  filter(grepl("old", age),
         !grepl("year[- ]old", age)
         ) %>% 
  select(user, age)
```

```{r}
## Cleanup age data
raw <- raw %>%
  mutate(age = tolower(age),
         age = plyr::mapvalues(age,
                               from = grep("taking", age, value = TRUE),
                               to = grep("taking", age, value = TRUE) %>%
                                 substr(0, 2),
                               warn_missing = FALSE),
         age = plyr::mapvalues(age,
                               from = grep("^\\d+[,:]$", age, value = TRUE),
                               to = grep("^\\d+[,:]$", age, value = TRUE) %>%
                                 sub("[,:]$", "", .),
                               warn_missing = FALSE),
         age = plyr::mapvalues(age,
                               from = grep("43!", age, value = TRUE),
                               to = 43,
                               warn_missing = FALSE),
         age = plyr::mapvalues(age,
                               from = grep("^40. deal with it.|^45, but the|^50 \\(despair\\)",
                                           age, value = TRUE),
                               to = grep("^40. deal with it.|^45, but the|^50 \\(despair\\)",
                                         age, value = TRUE) %>%
                                 substr(0, 2),
                               warn_missing = FALSE),
         age = suppressWarnings(as.integer(age)),
         age = ifelse(age > 116 | age < 1, NA, age)
  )
```

The distribution of the ages:
```{r ages}
raw %>% 
  ggplot(aes(x = age, y = ..count..)) + 
  geom_bar(binwidth=1)
```

Here is a summary:
```{r}
summary(raw$age) %>% 
  broom::tidy()
```


**Cleanup `n_mints`**, but first need to see what needs to be done:

```{r}
raw %>%
  filter(!grepl("^\\d+$", n_mints), !is.na(n_mints), !grepl("_", n_mints)) %>% 
  mutate(n_mints = tolower(n_mints)) %>% 
  group_by(n_mints) %>% 
  summarise(count = length(n_mints)) %>% 
  arrange(desc(count)) %>% 
  knitr::kable()
```

To do:

- Removing punctuation at the end of strings e.g. "5?", "7!"
- Mapping any string starting with 0 or contains "zero" or "none" to be 0 e.g. "0 - you ate them", "zero! who keeps mints in their hand", "none i hate mints"
- Removing commas in strings that contain only digits/commas e.g. "5,000"
- Manually revalue some factors e.g. "six" is 6 and "7.3/4" is 1.825
- Converting values to integers (and replacing those that fail conversion with NA)
- Replacing negative integers with NA (since this is count data)

```{r}
raw <- raw %>%
  mutate(
    n_mints = tolower(n_mints),
    n_mints = plyr::mapvalues(n_mints,
                              from = grep("[.!?]$", n_mints, value=TRUE),
                              to   = grep("[.!?]$", n_mints, value=TRUE) %>%
                                gsub("[.!?]$", "", .),
                              warn_missing = FALSE),
    n_mints = plyr::mapvalues(n_mints,
                              from = grep("^0|^zero|none", n_mints, value = TRUE),
                              to   = grep("^0|^zero|none", n_mints, value = TRUE) %>%
                                length() %>%
                                rep(0, .),
                              warn_missing = FALSE),
    n_mints = plyr::mapvalues(n_mints,
                              from = grep("^\\d+,[.,0-9]+$", n_mints, value = TRUE),
                              to   = grep("^\\d+,[.,0-9]+$", n_mints, value = TRUE) %>%
                                gsub(",", "", .)),
    n_mints = plyr::revalue(n_mints, replace = c("one"=1, "two"=2, "three"=3, "four"=4, "five"=5,
                                                 "six"=6, "seven"=7, "eight"=8, "nine"=9, "ten"=10,
                                                 "twelve"=12, "π"=pi,
                                                 "2 1/2"=2.5, "420+69"=489, "7.3/4"=1.825,
                                                 "1 billion"=1000000000),
                            warn_missing = FALSE),
    n_mints = suppressWarnings(as.integer(n_mints)),
    n_mints = ifelse(n_mints < 0, NA, n_mints)
  )
```

Here is a summary of the guesses.
```{r}
summary(raw$n_mints) %>% 
  broom::tidy()
```

These people guest the greatest number of mints:
```{r}
raw %>% 
  select(user, n_mints) %>% 
  arrange(desc(n_mints)) %>% 
  head(10) %>% 
  knitr::kable()
```

The distribution of mint guesses from 0 to 100 -- most people guess between 0 - 5 mints.
```{r mints}
raw %>% 
  ggplot(aes(x = n_mints, y = ..count..)) + 
  geom_bar(binwidth=5) +
  xlim(0,100)
```

At this point I have, 

- created user ids
- cleaned the timestamp
- cleaned the ages
- cleaned the guess of mints in my hand
- renamed the headers for the candy data and am keeping the despair and joy for candy data

```{r}
processed <- raw
rm(raw)
```

## The answers:
Now that the data is clean, we can answer the questions posed previously.

> 1. If you guess there is more mints in my hand, do you feel more joy towards mint candy?

**Figuring out how many mints is "more mints"**
```{r mints_gess, fig.keep='last'}
processed %>% 
  select(n_mints) %>% 
  gather(factor,guess) %>% 
  ggplot(aes(x = factor, y = guess)) +
  geom_boxplot() +
  ylim(0,100) +
  xlab("") + 
  coord_flip()

summary(processed$n_mints) %>% 
broom::tidy()
```

From the boxplot and 3rd quantile, we see that most people guess there are less than 10 mints in my hand. (From the warning we can also see that 707 surveyees predicted more than 100 mints.) We will thus divide the surveyees into 2 groups: those with guesses less than 10, and those with guesses 10 or more. 

**The groupings**
```{r}
processed <- processed %>% 
  mutate(more_group = n_mints >= 10)

processed %>% 
  group_by(more_group) %>% 
  summarise(n = length(more_group),
            fraction = n / nrow(processed)) %>% 
  knitr::kable()
```

From this table, we see that 21.3% of surveyees have a guess of 10 or more, 67.5% have a guess of less than 10, and 11.1% did not respond.

**Preferences of each group**
Here we summarize the preference of each group. Scoring is based on JOY = +1 and DESPAIR = -1 normalized by the number of people who voted.
```{r}
find_sum <- function(x, is_joy=TRUE, find_diff=FALSE){
  if (find_diff) {
    ## THIS HERE WILL GIVE A SCORE OF (JOY-DESPAIR)/(NUMBER OF PEOPLE WHO VOTED)
    (sum(x == "JOY", na.rm = TRUE) - sum(x == "DESPAIR", na.rm = TRUE)) / 
      sum(x == "JOY" | x == "DESPAIR", na.rm = TRUE)
  } else {
    ## THIS HERE WILL GIVE COUNT OF "JOY" OR "DESPAIR"
    feeling = ifelse(is_joy, "JOY", "DESPAIR")
    ifelse(is_joy, 
           sum(x == feeling, na.rm = TRUE),
           -sum(x == feeling, na.rm = TRUE))
           
  }
}
  
d1 <- processed %>% 
  group_by(more_group) %>% 
  summarise(
    `Junior Mints` = find_sum(`Junior Mints`, find_diff=T),
    `Senior Mints` = find_sum(`Senior Mints`, find_diff=T),
    `Mint Kisses` = find_sum(`Mint Kisses`, find_diff=T),
    `Mint Juleps` = find_sum(`Mint Juleps`, find_diff=T),
    `Mint Leaves` = find_sum(`Mint Leaves`, find_diff=T),
    `Mint M&Ms` = find_sum(`Mint M&Ms`, find_diff=T),
    `York Peppermint Patties` = find_sum(`York Peppermint Patties`, find_diff=T)
  ) %>% 
  gather(candy, score, -more_group)
```

```{r q1}
d1_order <- d1 %>% 
  filter(more_group == TRUE) %>% 
  arrange(desc(score)) %>% 
  .$candy %>% 
  as.character()

d1$candy <- factor(d1$candy, levels = d1_order)
d1 %>% 
  filter(!is.na(more_group)) %>% 
  ggplot(aes(x = candy, y = score, color = more_group, group = more_group)) + 
  geom_point(size = 3.5, alpha = 0.7) + 
  geom_line() + 
  xlab("") +
  ylab("level of joy") +
  coord_flip() +
  theme_bw()
```

From this plot, we can see that: 

- surveyees who has predicted more mints in my hand (BLUE) marginally finds more joy in 4 mint candies (Senior Mints, Mint Leaves, Mint Kisses, and Mint Juleps)
- surveyees who has predicted less mints in my hand (RED) marginally finds more joy in 3 mint candies (Mint M&Ms, Junior Mints, and York Peppermint Patties)
- those who has predicted more mints (BLUE) find more joy in "Senior Mints" 
- those who has predicted less mints (RED) find more joy in "Junior Mints"
- the general feeling of mint candy is despair since 5 out 7 mint candy score negatively in the level of joy (where positive = joy and negative = despair)

**Answer #1:** If one were to guess there is more mints in my hand, then in general yes you do feel marginally more joy towards mint candy. 

> 2. If you’re taking the survey late at night, do you guess there is more mints in my hand?

Arbitrarily, I'm going to define "late at night" as between 11PM - 3AM.

```{r}
processed <- processed %>% 
  mutate(nearest_hour = format(round(timestamp, units="hours"), format="%H:%M"),
         late_night = nearest_hour %in% c("23:00", "00:00", "01:00", "02:00", "03:00"))
```

Here is when surveyees responded:
```{r timestamp}
processed %>% 
  ggplot(aes(x = nearest_hour, y = ..count.., fill = late_night)) + 
  geom_bar() +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

```{r}
processed %>% 
  select(late_night, n_mints) %>% 
  ggplot(aes(x = late_night, y = n_mints, fill = late_night)) +
  geom_boxplot() + 
  stat_summary(fun.y = mean, geom="point", color="red", size=4, alpha=0.6) + 
  ylim(0, 20) +
  theme_bw()
```

*Note: red dot denotes the mean*

**Answer:** The answer looks to be no, if one was taking the survey late at night, one does not guess there is more mints in my hand. 

Follow-up: What if I group by the nearest hour instead of late night?

```{r}
processed %>% 
  select(nearest_hour, n_mints) %>% 
  ggplot(aes(x = nearest_hour, y = n_mints)) +
  geom_boxplot() + 
  stat_summary(fun.y = mean, geom="point", color="red", size=3.5, alpha=0.6) + 
  ylim(0, 20) + 
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5)
  )
```

*Note: red dot denotes the mean*

According to the figure, the guess in the number of mints in my hand doesn't really change according to when the survey was submitted.

> 3. Do people 40 or older feel more joy towards mint candy?

Recall the age of our surveyees:
```{r}
processed %>% 
  ggplot(aes(x=age, y=..count..)) + 
  geom_bar(binwidth=1, origin=-0.5) + 
  geom_vline(xintercept=39.5, color="red", alpha=0.6) + 
  annotate("text", x=10, y=225, label="fresh", size=10, color="grey60") +
  annotate("text", x=59, y=225, label="ripe", size=10, color="grey60") +
  theme_bw()
```

The horizontal line represents the split in our age groups: "ripe" for those 40 or older and "fresh" for those younger than 40.

```{r}
## get data
d3 <- processed %>% 
  mutate(age_grp = ifelse(age < 40, "fresh", "ripe")) %>% 
  filter(!is.na(age_grp)) %>% 
  group_by(age_grp) %>% 
  summarise(
    `Junior Mints` = find_sum(`Junior Mints`, find_diff=T),
    `Senior Mints` = find_sum(`Senior Mints`, find_diff=T),
    `Mint Kisses` = find_sum(`Mint Kisses`, find_diff=T),
    `Mint Juleps` = find_sum(`Mint Juleps`, find_diff=T),
    `Mint Leaves` = find_sum(`Mint Leaves`, find_diff=T),
    `Mint M&Ms` = find_sum(`Mint M&Ms`, find_diff=T),
    `York Peppermint Patties` = find_sum(`York Peppermint Patties`, find_diff=T)
  ) %>% 
  gather(candy, score, -age_grp)

## reorder factor
d3_order <- d3 %>% 
  filter(age_grp == "ripe") %>% 
  arrange(desc(score)) %>% 
  .$candy %>% 
  as.character()
d3$candy <- factor(d3$candy, levels = d3_order)

## plot
d3 %>% 
  ggplot(aes(x = candy, y = score, color = age_grp, group = age_grp)) + 
  geom_point(size=3.5, alpha=0.6) + 
  geom_line() + 
  xlab("") + 
  coord_flip() + 
  theme_bw()
```

Out of the 7 mint candies, the ripe group feels more joy for 3 (Senior Mints, Junior Mints, and York Peppermint Patties) of them and the the fresh group feels more joy for 4 (Mint Leaves, Mint Kisses, Mint M&Ms, and Mint Juleps) of them. This therefore shows that ...

**Answer**: No, people 40 or older does not feel more joy towards mint candy.

> 4. Given the people who said they were old, are we able to predict their age given preference towards mint candy & the number of mints they guess?

The following surveyees self reported they were "old". 
```{r}
(self_reported_as_old_users <- self_reported_as_old$user)
```
*(Note: You can scroll down to see their self reporting).*

I want to know if I can predict their age given their preference towards the 7 mint candy & the number of mints they guess. To do this, I will split my data into `test_data` and `train_data`. The `test_data` contains the information of the surveyees who has self reported as "old". The `train_data` contains the information from the other surveyees.

To make my life easier, I will disclude surveyees whose information contain NA for any of the 7 candies or the number of mints they guess.

```{r}
## Make life easier and drop users if they have NA in any of the 7 candies or NA in n_mints
test_data <- processed %>% 
  filter(user %in% self_reported_as_old_users,
         !is.na(n_mints),
         !is.na(`Junior Mints`),
         !is.na(`Senior Mints`),
         !is.na(`Mint Kisses`),
         !is.na(`Mint Juleps`),
         !is.na(`Mint Leaves`),
         !is.na(`Mint M&Ms`),
         !is.na(`York Peppermint Patties`)
  )

train_data <- processed %>% 
  filter(!user %in% self_reported_as_old_users,
         !is.na(age),
         !is.na(n_mints),
         !is.na(`Junior Mints`),
         !is.na(`Senior Mints`),
         !is.na(`Mint Kisses`),
         !is.na(`Mint Juleps`),
         !is.na(`Mint Leaves`),
         !is.na(`Mint M&Ms`),
         !is.na(`York Peppermint Patties`)
  )  
```

**Size of train and test set**
My training data has the following number of surveyees:
```{r}
nrow(train_data)
```

My test data has the following number of surveyees who has self reported as old:
```{r}
nrow(test_data)
```

**Train model**: The model I will employ is linear regression. This is chosen because it is easy to implement and it was seen in class before. 
```{r}
## Fit linear model
fit <- lm(age ~ n_mints + `Junior Mints` + `Senior Mints` + `Mint Kisses` + 
            `Mint Juleps` + `Mint Leaves` + `Mint M&Ms` + `York Peppermint Patties`, 
          data=train_data)

## Summarize results
summary(fit)
```

To get and idea of error:

- take difference between actual & predicted for each surveyee
- square the difference for each surveyee
- take sum of all squared differences
- divide by number of surveyees to get an average squared
- square root to remove squared term

```{r}
y_hat <- predict(fit, train_data)
y     <- train_data$age

## Estimate of error
(err <- sqrt(sum((y - y_hat)^2) / length(y)))
```

**Prediction**: My model is not fitted/trained. I can now use it to predict on the test data.
```{r}
self_reported_as_old_predictions <- 
  ## make model prediction
  predict(fit, test_data) %>% 
  
  ## combine with test data to get user ID
  cbind(test_data,
        predicted_age = .) %>% 
  select(user, predicted_age) %>% 
  
  ## join with 'self_reported_as_old' to original response to "age" variable (before cleanup)
  left_join(., self_reported_as_old, by="user") %>% 
  select(user, age, predicted_age)
  
self_reported_as_old_predictions %>% 
  knitr::kable()
```

Distribution of surveyees who has self reported as old:
```{r}
self_reported_as_old_predictions %>% 
  mutate(predicted_age = as.integer(predicted_age)) %>% ## convert to integer
  
  ## get count data
  group_by(predicted_age) %>%  
  summarise(count = length(predicted_age)) %>% 
  
  ## plot
  ggplot(aes(x = predicted_age, y = count)) + 
  geom_bar(stat="identity") +
  scale_x_continuous(breaks = seq(30,40,1)) + 
  theme_bw()
```

**Answer**: Overall, prediction is possible and most people who has self reported as old are predicted to be between 31 to 40 (+/- `r round(err)`); majority being 36.

## Reflection 
- tidying data is tedious
- analysis took a fraction of the time tidying did